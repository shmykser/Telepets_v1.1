## Дорожная карта развития Telepets (v1.1 → v2.x)

### Цели и видение
- Создать стабильный, масштабируемый и монетизируемый Telegram Web App‑тамагочи с реалистичными изображениями питомцев и глубокой игровой петлёй (care → progress → rewards → cosmetics/collection).
- Сохранить текущую архитектуру (FastAPI + React) и централизованную конфигурацию (`backend/config/settings.py`).

### Вехи (Milestones)
1. v1.2 Качество и устойчивость (2–3 недели)
   - **База**: Alembic миграции в CI, переход на Postgres (dev/prod), SQLite оставить для локалки.
   - **Стабильность генерации**: очереди задач, таймауты, ретраи, понятные ошибки.
   - **Summary API**: расширение (готово) + пагинация списков, консистентные схемы ответов.
   - **Мониторинг**: метрики по очередям, генерации и ошибкам; улучшенные логи без эмодзи на Windows.
   - **Тесты**: unit + интеграционные для API, базовые Playwright‑сценарии фронта.

2. v1.3 Геймплей и экономика (3–4 недели)
   - **Экономика**: интеграция Telegram Stars/платежей, верификация квитанций, магазин (еда/лечения/игрушки/скины), daily/weekly stеak‑системы.
   - **Геймплей**: задания/квесты, мини‑игры «кликер‑стиля», статусы состояния (голод, настроение, чистота).
   - **Достижения**: расширение набора, награды, прогресс‑трекинг.
   - **UI/UX**: прогресс бары, таймеры, подсказки; WebApp‑инициализация и проверка `initData` (подпись Telegram).

3. v1.4 Контент и визуал (3–5 недель)
   - **Генерация**: предгенерация следующей стадии, кэширование; seed‑репродуцируемость; выбор модели/пресета качества.
   - **Коллекции**: галерея питомцев, редкие скины; экспорт/шаринг изображений.
   - **Локализация**: RU/EN, вынос строк.

4. v2.0 Масштабирование и продвинутые фичи (6–10 недель)
   - **Реалтайм**: WebSocket/SSE для обновления здоровья/стадий.
   - **Событийная архитектура**: event log, outbox/consumer для «экономика/уведомления/аналитика».
   - **Админ‑панель**: модерация контента, лидеры, управление акциями.
   - **Анти‑фрод**: лимиты, поведенческие фильтры, защита оплаты.

---

### Backend
- **База данных**:
  - Postgres (prod): `DATABASE_URL` через .env; Alembic как единственный способ изменения схемы.
  - Миграции: автоген + ручные правки, pre‑commit проверка на наличие миграций.
- **API и схемы**:
  - Консистентные Pydantic‑схемы ответов, код ошибок, пагинация, сортировка.
  - Rate limiting для чувствительных маршрутов.
- **Хранение изображений**:
  - Источник истины: поля `image_*_b64` (сохранено).
  - Опционально (оптимаизация): бэкграунд‑выгрузка большой истории в объектное хранилище (S3) с сохранением «истины» в БД, чтобы не нарушать текущее требование.
- **Очереди/таски**:
  - Планировщик на asyncio/apscheduler; опционально Celery/RQ при росте нагрузки.
  - Ретраи, backoff, idempotency‑keys для генерации/переходов.
- **Безопасность**:
  - Верификация Telegram WebApp `initData` (подпись) для всех пользовательских запросов.
  - JWT для админ‑интерфейса.

### Генерация изображений (AI)
- **Надёжность**: таймауты, ретраи, фолбэки; явный статус генерации.
- **Качество**: регулировка пресетов, негативных промптов по стадиям; лог экспериментов.
- **Производительность**: предген текущей/следующей стадии, прогрев кэша, ограничение одновременных запросов на пользователя.
- **Репродуцируемость**: seed в метаданных, повтор генерации.

### Экономика и монетизация
- **Платежи**: Telegram Stars/Pay, обработка webhook/статусов, повторная доставка событий.
- **Магазин**: предметы ухода/бустеры/скины; ценообразование per stage.
- **Балансировка**: таблицы стоимости и наград; A/B тесты (разные конфигурации через флаги).
- **Анти‑фрод**: лимиты по IP/пользователю/времени, мониторинг аномалий.

### Геймдизайн
- **Состояния питомца**: голод/настроение/чистота (влияют на здоровье/переход стадии).
- **Ежедневные/недельные активности**: streak, миссии, события.
- **Коллекции и редкости**: классы редкости, сезонные скины.

### Frontend (Telegram Web App)
- **Интеграция**: корректная инициализация WebApp, использование `initDataUnsafe` для user_id.
- **UI/UX**: skeletons/спиннеры, «toasts» по экономике, доступность (a11y), адаптивная верстка.
- **Реалтайм**: обновление здоровья/таймера через SSE/WebSocket.
- **Клиентская аналитика**: события UI → backend (privacy‑safe).

### Мониторинг и аналитика
- **Метрики**: latency/ошибки по эндпоинтам, очереди генерации, конверсии экономики.
- **Дашборды**: Grafana/Prometheus (или расширение текущего мониторинга).
- **События**: аудит действий (экономика/достижения/переходы), экспорт в data‑lake (по мере роста).

### Тестирование и качество
- **Backend**: pytest, coverage ≥ 80%, property‑based для экономики.
- **E2E**: Playwright (основные сценарии: создание, health_up, покупка, смена стадии, отображение изображения).
- **Нагрузочное**: k6/Locust профиль health‑задач и генерации.
- **Безопасность**: валидация `initData`, фуззинг входов, линтеры/форматеры.

### CI/CD и инфраструктура
- **CI**: линтеры, типы, тесты, миграции, сборка фронта.
- **CD**: Docker/Compose; для prod — образ, миграции перед стартом, health‑checks.
- **Secrets**: .env шаблоны, безопасное хранение секретов.

### Документация
- Поддерживать `docs/FEATURES.md`, `docs/SETUP.md`, `docs/MIGRATIONS.md`, `backend/docs/pet_images_api.md` в актуальном виде.
- Добавить диаграммы архитектуры (Mermaid), ADR на ключевые решения.
- Swagger описания для всех новых эндпоинтов.

### Таймлайн (ориентировочно)
- **0–2 недели**: миграции/стабильность/тесты/мониторинг, минимальные UX‑фиксы.
- **3–6 недель**: экономика, платежи, новый контент/квесты, улучшенная генерация и предген.
- **6–12 недель**: реалтайм/событийность, админ‑панель, аналитика, масштабирование.

### Риски и смягчение
- **Неустойчивость генерации**: многоступенчатый фолбэк, ретраи, ограничения частоты.
- **Нагрузки**: предген/кэш, очереди, мониторинг; горизонтальное масштабирование.
- **Фрод/читерство**: верификация Telegram, лимиты, аномалия‑детект, модерация.


